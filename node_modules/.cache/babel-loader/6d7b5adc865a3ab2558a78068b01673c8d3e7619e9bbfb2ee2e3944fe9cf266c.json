{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/web.url-search-params.delete.js\";\nimport \"core-js/modules/web.url-search-params.has.js\";\nimport \"core-js/modules/web.url-search-params.size.js\";\nimport axios from \"axios\";\nexport default {\n  name: \"FinalStep\",\n  props: {\n    content: {\n      type: String,\n      required: true\n    },\n    generatedImage: {\n      type: String,\n      default: null\n    },\n    projectId: {\n      type: String,\n      default: \"\"\n    },\n    projectTitle: {\n      type: String,\n      default: \"Content Project\"\n    },\n    projectDescription: {\n      type: String,\n      default: \"\"\n    },\n    contentId: {\n      type: String,\n      default: \"\"\n    },\n    fromDashboard: {\n      type: Boolean,\n      default: false\n    }\n  },\n  data() {\n    return {\n      projectStatus: \"in_progress\",\n      loading: false,\n      error: null,\n      saveLoading: false,\n      saveMessage: null,\n      saveStatus: \"success\",\n      imageLoading: false,\n      imageError: null,\n      localImage: this.generatedImage,\n      toasts: []\n    };\n  },\n  computed: {\n    apiEndpoint() {\n      return process.env.VUE_APP_API_URL || \"http://localhost:3001/api\";\n    },\n    hasProjectId() {\n      return this.projectId && this.projectId.length > 0;\n    },\n    hasContentId() {\n      return this.contentId && this.contentId.length > 0;\n    },\n    formattedContent() {\n      if (!this.content) return \"\";\n\n      // Tạo định dạng HTML cho nội dung\n      const formatted = this.content\n      // Thay thế dòng trống bằng thẻ đoạn\n      .replace(/\\n\\s*\\n/g, \"</p><p>\")\n      // Thay thế dòng mới đơn bằng thẻ br\n      .replace(/\\n/g, \"<br>\")\n      // Bọc toàn bộ nội dung trong thẻ p\n      .replace(/^(.+)$/, \"<p>$1</p>\");\n      return formatted;\n    },\n    imageUrl() {\n      // First, use localImage from data if available\n      if (this.localImage) {\n        console.log(\"Using local image:\", this.localImage.substring(0, 50) + \"...\");\n\n        // Ensure the URL is properly formatted for deployment\n        return this.ensureAbsoluteUrl(this.localImage);\n      }\n\n      // Next, try to use generated image from props\n      if (this.generatedImage) {\n        console.log(\"Using generated image from props:\", typeof this.generatedImage === \"string\" ? this.generatedImage.substring(0, 50) + \"...\" : \"object\");\n\n        // Handle string URLs (including data URLs)\n        if (typeof this.generatedImage === \"string\") {\n          return this.ensureAbsoluteUrl(this.generatedImage);\n        }\n\n        // Handle object format\n        if (typeof this.generatedImage === \"object\" && this.generatedImage !== null) {\n          if (\"image\" in this.generatedImage) {\n            return this.ensureAbsoluteUrl(this.generatedImage.image);\n          }\n          if (\"imageUrl\" in this.generatedImage) {\n            return this.ensureAbsoluteUrl(this.generatedImage.imageUrl);\n          }\n        }\n      }\n      return null;\n    }\n  },\n  created() {\n    console.log(\"FinalStep created\");\n    console.log(\"generatedImage prop:\", this.generatedImage);\n    console.log(\"contentId prop:\", this.contentId);\n\n    // Set initial local image from props\n    if (this.generatedImage) {\n      this.localImage = this.generatedImage;\n    } else {\n      this.localImage = null;\n    }\n    if (this.hasProjectId) {\n      this.fetchProjectStatus();\n    }\n\n    // Always fetch content image if we have contentId, regardless of generatedImage prop\n    if (this.hasContentId) {\n      this.fetchContentImage();\n    }\n  },\n  mounted() {\n    console.log(\"FinalStep mounted, contentId:\", this.contentId);\n    console.log(\"From dashboard:\", this.fromDashboard);\n    console.log(\"Generated image from props:\", !!this.generatedImage);\n\n    // Thêm giá trị mặc định cho toasts\n    if (!this.toasts) {\n      this.toasts = [];\n    }\n\n    // Tải lại dữ liệu hình ảnh từ cơ sở dữ liệu nếu có contentId\n    if (this.contentId && (!this.generatedImage || this.fromDashboard)) {\n      console.log(\"Loading image data from database...\");\n      this.loadImageFromDatabase();\n    }\n  },\n  methods: {\n    async fetchProjectStatus() {\n      try {\n        if (!this.hasProjectId) return;\n        const response = await axios.get(`${this.apiEndpoint}/projects/${this.projectId}`);\n        if (response.data.success) {\n          this.projectStatus = response.data.data.status;\n        }\n      } catch (error) {\n        console.error(\"Error fetching project status:\", error);\n        this.error = \"Could not fetch project status\";\n      }\n    },\n    async fetchContentImage() {\n      this.imageLoading = true;\n      this.imageError = false;\n      try {\n        console.log(\"Fetching content image...\");\n        if (!this.contentId) {\n          console.error(\"No content ID available\");\n          throw new Error(\"Không có ID nội dung để tải hình ảnh\");\n        }\n\n        // Ưu tiên sử dụng endpoint content-image để lấy ảnh từ database\n        const contentImageUrl = `/api/image/content-image/${this.contentId}`;\n        console.log(`Trying content-image endpoint: ${contentImageUrl}`);\n        try {\n          // Kiểm tra xem ảnh có tồn tại trong database không\n          const testImg = new Image();\n          const imageLoadPromise = new Promise(resolve => {\n            testImg.onload = () => resolve(true);\n            testImg.onerror = () => resolve(false);\n          });\n          testImg.src = contentImageUrl;\n          const imageExists = await imageLoadPromise;\n          if (imageExists) {\n            console.log(\"Image exists in database, using content-image endpoint\");\n            this.imageUrl = this.ensureAbsoluteUrl(contentImageUrl);\n            this.contentImage = this.imageUrl;\n            this.imageLoading = false;\n            return;\n          }\n        } catch (e) {\n          console.log(\"Error checking content-image endpoint:\", e);\n        }\n        console.log(\"Image not found in database, checking content record\");\n\n        // Nếu không tìm thấy trong database, thì kiểm tra từ API\n        const controller = new AbortController();\n        const timeoutId = setTimeout(() => controller.abort(), 10000);\n        const response = await axios.get(`/api/content/contents/${this.contentId}`, {\n          signal: controller.signal\n        });\n        clearTimeout(timeoutId);\n        if (response.data && response.data.success) {\n          const contentData = response.data.data;\n          console.log(\"Full content data:\", contentData);\n          if (contentData && contentData.imageUrl) {\n            console.log(`Found image URL for content ${this.contentId}:`, contentData.imageUrl);\n\n            // Check for content-image endpoint first (highest priority)\n            if (contentData.imageUrl.includes(\"/content-image/\")) {\n              const imageUrl = this.ensureAbsoluteUrl(contentData.imageUrl);\n              console.log(`Using content-image URL: ${imageUrl}`);\n              this.imageUrl = imageUrl;\n              this.contentImage = imageUrl;\n              this.imageLoading = false;\n              return;\n            }\n\n            // Check filename pattern next\n            const imageFilenameMatch = contentData.imageUrl.match(/image_\\d+\\.png/);\n            if (imageFilenameMatch) {\n              const filename = imageFilenameMatch[0];\n              console.log(`Detected image filename pattern directly in content data: ${filename}`);\n\n              // Create absolute URL to image uploads endpoint\n              const directUrl = `${window.location.origin}/api/image/uploads/${filename}`;\n              console.log(\"Created direct URL to image:\", directUrl);\n              this.imageUrl = directUrl;\n              this.contentImage = directUrl;\n              this.imageLoading = false;\n              return;\n            }\n\n            // Kiểm tra đường dẫn hình ảnh\n            if (contentData.imageUrl.includes(\"undefined\") || contentData.imageUrl === \"null\" || contentData.imageUrl === \"\") {\n              console.error(\"Invalid image URL detected:\", contentData.imageUrl);\n              this.imageError = \"URL hình ảnh không hợp lệ\";\n              this.imageLoading = false;\n              return;\n            }\n\n            // Store the original URL\n            const originalUrl = contentData.imageUrl;\n            console.log(\"Original image URL:\", originalUrl);\n\n            // Use the original URL with proper handling\n            this.imageUrl = this.ensureAbsoluteUrl(originalUrl);\n            this.contentImage = this.imageUrl;\n            this.imageLoading = false;\n          } else {\n            console.log(`No image found for content ${this.contentId}`);\n            this.imageUrl = null;\n            this.imageLoading = false;\n            this.imageError = \"Không tìm thấy hình ảnh trong cơ sở dữ liệu\";\n          }\n        } else {\n          console.warn(\"API did not return success:\", response.data);\n          this.imageUrl = null;\n          this.imageLoading = false;\n          this.imageError = \"Lỗi khi lấy dữ liệu nội dung\";\n        }\n      } catch (error) {\n        console.error(\"Error in fetchContentImage:\", error);\n        if (error.name === \"AbortError\") {\n          this.imageError = \"Request timed out when loading image\";\n        } else {\n          this.imageError = \"Failed to load image: \" + error.message;\n        }\n        this.imageUrl = null;\n        this.imageLoading = false;\n      }\n    },\n    async markAsFinished() {\n      try {\n        if (!this.hasProjectId) {\n          alert(\"Cannot update status: No project ID available\");\n          return;\n        }\n        this.loading = true;\n        const response = await axios.patch(`${this.apiEndpoint}/projects/${this.projectId}/status`, {\n          status: \"finished\"\n        });\n        if (response.data.success) {\n          this.projectStatus = \"finished\";\n        }\n      } catch (error) {\n        console.error(\"Error updating project status:\", error);\n        alert(\"Failed to update project status: \" + error.message);\n      } finally {\n        this.loading = false;\n      }\n    },\n    async markAsInProgress() {\n      try {\n        if (!this.hasProjectId) {\n          alert(\"Cannot update status: No project ID available\");\n          return;\n        }\n        this.loading = true;\n        const response = await axios.patch(`${this.apiEndpoint}/projects/${this.projectId}/status`, {\n          status: \"in_progress\"\n        });\n        if (response.data.success) {\n          this.projectStatus = \"in_progress\";\n        }\n      } catch (error) {\n        console.error(\"Error updating project status:\", error);\n        alert(\"Failed to update project status: \" + error.message);\n      } finally {\n        this.loading = false;\n      }\n    },\n    async saveContent() {\n      try {\n        if (!this.hasContentId) {\n          this.saveMessage = \"No content ID available. Cannot save.\";\n          this.saveStatus = \"error\";\n          return;\n        }\n        this.saveLoading = true;\n        this.saveMessage = null;\n        const response = await axios.put(`${this.apiEndpoint}/content/contents/${this.contentId}`, {\n          generatedContent: this.content\n        });\n        if (response.data.success) {\n          this.saveMessage = \"Content saved successfully!\";\n          this.saveStatus = \"success\";\n          // Emit event to update parent content\n          this.$emit(\"update:content\", this.content);\n        } else {\n          throw new Error(response.data.error || \"Unknown error occurred\");\n        }\n      } catch (error) {\n        console.error(\"Error saving content:\", error);\n        this.saveMessage = \"Failed to save content: \" + error.message;\n        this.saveStatus = \"error\";\n      } finally {\n        this.saveLoading = false;\n\n        // Clear message after 3 seconds\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n      }\n    },\n    exportContent() {\n      try {\n        // Tạo dữ liệu để export\n        const exportData = {\n          title: this.projectTitle || \"Untitled Content\",\n          content: this.content,\n          image: this.imageUrl,\n          createdAt: new Date().toISOString(),\n          projectInfo: {\n            id: this.projectId,\n            title: this.projectTitle,\n            description: this.projectDescription\n          }\n        };\n\n        // Tạo JSON string\n        const dataStr = JSON.stringify(exportData, null, 2);\n\n        // Tạo blob để download\n        const blob = new Blob([dataStr], {\n          type: \"application/json\"\n        });\n        const url = URL.createObjectURL(blob);\n\n        // Tạo link và kích hoạt download\n        const a = document.createElement(\"a\");\n        a.download = `${this.projectTitle || \"content\"}_export.json`;\n        a.href = url;\n        a.click();\n\n        // Giải phóng URL object\n        URL.revokeObjectURL(url);\n        this.saveMessage = \"Content exported successfully!\";\n        this.saveStatus = \"success\";\n\n        // Clear message after 3 seconds\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n      } catch (error) {\n        console.error(\"Error exporting content:\", error);\n        this.saveMessage = \"Failed to export content: \" + error.message;\n        this.saveStatus = \"error\";\n\n        // Clear message after 3 seconds\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n      }\n    },\n    shareContent() {\n      // Xử lý chia sẻ nội dung - có thể thông qua email hoặc mạng xã hội\n      try {\n        // Kiểm tra nếu Web Share API được hỗ trợ\n        if (navigator.share) {\n          navigator.share({\n            title: this.projectTitle || \"My Content\",\n            text: `Check out my content: ${this.projectTitle || \"Content\"}`,\n            url: window.location.href\n          }).then(() => {\n            this.saveMessage = \"Content shared successfully!\";\n            this.saveStatus = \"success\";\n          }).catch(error => {\n            throw error;\n          });\n        } else {\n          // Fallback - copy URL vào clipboard\n          navigator.clipboard.writeText(window.location.href).then(() => {\n            this.saveMessage = \"URL copied to clipboard!\";\n            this.saveStatus = \"success\";\n          });\n        }\n\n        // Clear message after 3 seconds\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n      } catch (error) {\n        console.error(\"Error sharing content:\", error);\n        this.saveMessage = \"Failed to share content: \" + error.message;\n        this.saveStatus = \"error\";\n\n        // Clear message after 3 seconds\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n      }\n    },\n    downloadPDF() {\n      try {\n        // Thông báo cho người dùng rằng chức năng đang được phát triển\n        this.saveMessage = \"PDF download feature will be available soon.\";\n        this.saveStatus = \"success\";\n\n        // Xóa thông báo sau 3 giây\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n\n        // NOTE: Chức năng này sẽ được triển khai trong bản cập nhật tới\n        // Sử dụng thư viện như jsPDF hoặc html2pdf.js để tạo PDF từ nội dung\n      } catch (error) {\n        console.error(\"Error downloading PDF:\", error);\n        this.saveMessage = \"Failed to download PDF: \" + error.message;\n        this.saveStatus = \"error\";\n\n        // Clear message after 3 seconds\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n      }\n    },\n    goToDashboard() {\n      this.$emit(\"go-to-dashboard\");\n    },\n    async generateImageForContent() {\n      try {\n        this.imageLoading = true;\n        this.imageError = null;\n\n        // Hiển thị thông báo đang xử lý\n        this.showToast(\"Đang chuẩn bị tạo hình ảnh cho nội dung...\", \"info\");\n        if (!this.contentId) {\n          throw new Error(\"Không có ID nội dung để tạo hình ảnh\");\n        }\n\n        // Kiểm tra xem có nội dung không\n        if (!this.content || this.content.trim().length === 0) {\n          this.showToast(\"Không thể tạo hình ảnh: Nội dung trống\", \"error\");\n          throw new Error(\"Nội dung trống, không thể tạo hình ảnh\");\n        }\n        console.log(`Generating image for content ID: ${this.contentId}`);\n        console.log(`Content length: ${this.content.length} characters`);\n\n        // Bước 1: Tạo prompt từ nội dung\n        console.log(\"Step 1: Generating prompt from content\");\n        const promptResponse = await axios.post(`/api/content/contents/generate-prompt`, {\n          contentId: this.contentId,\n          style: \"Realistic\",\n          template: `Generate a [STYLE] image of [SUBJECT], featuring [KEY DETAILS]. Style: [ART STYLE/MEDIUM], color palette: [COLORS], lighting: [LIGHTING], composition: [COMPOSITION]. Additional effects: [EFFECTS]. Keep the overall mood [MOOD]. Render in Kandinsky 2.2 with high detail, resolution [RESOLUTION].`,\n          content: this.content\n        }, {\n          timeout: 45000 // 45 seconds timeout for prompt generation\n        });\n        if (!promptResponse.data.success) {\n          throw new Error(promptResponse.data.error || \"Lỗi khi tạo mô tả hình ảnh\");\n        }\n        const generatedPrompt = promptResponse.data.prompt;\n        console.log(\"Generated prompt:\", generatedPrompt.substring(0, 100) + \"...\");\n\n        // Hiển thị thông báo prompt đã được tạo\n        this.showToast(\"Đã tạo mô tả hình ảnh, đang tạo hình ảnh...\", \"success\");\n\n        // Bước 2: Tạo hình ảnh từ prompt\n        const imageResponse = await axios.post(`/api/image/generate`, {\n          prompt: generatedPrompt,\n          style: \"Realistic\",\n          width: 512,\n          height: 512,\n          num_inference_steps: 30\n        }, {\n          timeout: 180000 // 3 minutes timeout for image generation\n        });\n        if (!imageResponse.data.success) {\n          throw new Error(imageResponse.data.error || \"Lỗi khi tạo hình ảnh từ mô tả\");\n        }\n\n        // Kiểm tra nếu response có chứa dữ liệu hình ảnh dạng base64\n        if (imageResponse.data.image && imageResponse.data.image.startsWith(\"data:image\")) {\n          console.log(\"Received base64 image data from API\");\n\n          // Save base64 image to server and get URL\n          await this.saveBase64ImageToServer(imageResponse.data.image);\n          return;\n        }\n\n        // Trường hợp API trả về filename\n        const imageUrl = `/api/content/contents/${this.contentId}/images/${imageResponse.data.filename}`;\n\n        // Bước 3: Cập nhật URL hình ảnh vào nội dung\n        const updateResponse = await axios.put(`/api/content/contents/${this.contentId}`, {\n          imageUrl,\n          generatedContent: this.content // Thêm trường generatedContent để tránh lỗi\n        });\n        if (!updateResponse.data.success) {\n          throw new Error(updateResponse.data.error || \"Lỗi khi cập nhật URL hình ảnh\");\n        }\n\n        // Cập nhật URL hình ảnh vào local state\n        this.localImage = imageUrl;\n        this.$emit(\"update:image\", imageUrl);\n\n        // Hiển thị thông báo thành công\n        this.showToast(\"Đã tạo hình ảnh thành công!\", \"success\");\n      } catch (error) {\n        console.error(\"Error generating image for content:\", error);\n        let errorMessage = \"Lỗi không xác định\";\n\n        // Check for API response error\n        if (error.response) {\n          console.log(\"API response error:\", error.response.data);\n\n          // Handle specific error messages from server\n          if (error.response.data && error.response.data.error) {\n            errorMessage = error.response.data.error;\n\n            // Specific checks for common errors\n            if (errorMessage.includes(\"Missing required field\")) {\n              errorMessage = \"Thiếu trường dữ liệu cần thiết. Vui lòng thử lại.\";\n              console.log(\"Content availability:\", !!this.content);\n              console.log(\"ContentId availability:\", !!this.contentId);\n\n              // Try retrieving the content again if missing\n              if (this.contentId && (!this.content || this.content.trim().length === 0)) {\n                this.showToast(\"Đang thử tải lại nội dung...\", \"info\");\n                try {\n                  const contentResponse = await axios.get(`/api/content/contents/${this.contentId}`);\n                  if (contentResponse.data.success && contentResponse.data.data.generatedContent) {\n                    // Update the local content\n                    this.$emit(\"update:content\", contentResponse.data.data.generatedContent);\n                    this.showToast(\"Đã tải lại nội dung, vui lòng thử lại\", \"info\");\n                  }\n                } catch (reloadError) {\n                  console.error(\"Error reloading content:\", reloadError);\n                }\n              }\n            }\n          }\n        } else if (error.message) {\n          errorMessage = error.message;\n        }\n        this.imageError = `Lỗi khi tạo hình ảnh: ${errorMessage}`;\n\n        // Hiển thị thông báo lỗi\n        this.showToast(`Lỗi: ${errorMessage}`, \"error\");\n\n        // Nếu lỗi do timeout\n        if (error.message.includes(\"timeout\")) {\n          this.showToast(\"Quá thời gian chờ phản hồi. Vui lòng thử lại sau.\", \"error\");\n        }\n      } finally {\n        this.imageLoading = false;\n      }\n    },\n    async saveBase64ImageToServer(base64Data) {\n      try {\n        console.log(\"Saving base64 image to server...\");\n        if (!this.contentId) {\n          throw new Error(\"No content ID available\");\n        }\n\n        // Hiển thị thông báo đang xử lý\n        this.showToast(\"Đang lưu hình ảnh vào máy chủ...\", \"info\");\n\n        // 1. Gửi dữ liệu base64 đến API để lưu trên server\n        const saveResponse = await axios.post(\"/api/image/save-base64\", {\n          imageData: base64Data,\n          contentId: this.contentId\n        });\n        if (!saveResponse.data.success) {\n          throw new Error(saveResponse.data.error || \"Lỗi khi lưu hình ảnh\");\n        }\n\n        // 2. Lấy URL của hình ảnh đã lưu\n        const imageUrl = saveResponse.data.imageUrl;\n        console.log(\"Image saved successfully, URL:\", imageUrl);\n\n        // 3. Cập nhật URL hình ảnh vào content\n        const updateResponse = await axios.patch(`/api/content/contents/${this.contentId}/partial`, {\n          imageUrl\n        });\n        if (!updateResponse.data.success) {\n          throw new Error(updateResponse.data.error || \"Lỗi khi cập nhật URL hình ảnh\");\n        }\n\n        // 4. Cập nhật URL hình ảnh vào local state\n        this.localImage = imageUrl;\n        this.$emit(\"update:image\", imageUrl);\n\n        // Hiển thị thông báo thành công\n        this.showToast(\"Đã lưu hình ảnh thành công!\", \"success\");\n        this.imageError = null;\n      } catch (error) {\n        console.error(\"Error saving base64 image:\", error);\n\n        // Nếu đã có dữ liệu base64, vẫn hiển thị dù không lưu được\n        if (base64Data) {\n          this.localImage = base64Data;\n          this.$emit(\"update:image\", base64Data);\n          this.showToast(\"Hiển thị hình ảnh tạm thời. Không thể lưu vào máy chủ.\", \"warning\");\n        } else {\n          this.imageError = \"Không thể lưu hình ảnh vào máy chủ: \" + error.message;\n          this.showToast(\"Lỗi: \" + error.message, \"error\");\n        }\n      }\n    },\n    async updateImageUrlToDatabase() {\n      try {\n        // Kiểm tra xem có imageUrl trong local state không\n        if (!this.localImage || !this.contentId) {\n          console.error(\"Không có dữ liệu hình ảnh hoặc ID nội dung\");\n          return;\n        }\n        this.imageLoading = true;\n        this.showToast(\"Đang cập nhật hình ảnh vào cơ sở dữ liệu...\", \"info\");\n\n        // Lấy thông tin nội dung hiện tại\n        const contentResponse = await axios.get(`/api/content/contents/${this.contentId}`);\n        if (!contentResponse.data.success) {\n          throw new Error(\"Không thể lấy thông tin nội dung\");\n        }\n        const content = contentResponse.data.data;\n\n        // Nếu là data URL, cần lưu vào server trước\n        if (this.localImage.startsWith(\"data:image\")) {\n          await this.saveBase64ImageToServer(this.localImage);\n          return;\n        }\n\n        // Cập nhật URL\n        const updateResponse = await axios.put(`/api/content/contents/${this.contentId}`, {\n          imageUrl: this.localImage,\n          generatedContent: content.generatedContent || this.content\n        });\n        if (!updateResponse.data.success) {\n          throw new Error(updateResponse.data.error || \"Lỗi khi cập nhật URL hình ảnh\");\n        }\n        this.showToast(\"Đã cập nhật hình ảnh vào cơ sở dữ liệu!\", \"success\");\n      } catch (error) {\n        console.error(\"Error updating image URL:\", error);\n        this.showToast(\"Lỗi: \" + error.message, \"error\");\n      } finally {\n        this.imageLoading = false;\n      }\n    },\n    showToast(message, type = \"info\") {\n      if (!this.toasts) this.toasts = [];\n      const id = Date.now();\n      this.toasts.push({\n        id,\n        message,\n        type\n      });\n\n      // Tự động xóa sau 5 giây\n      setTimeout(() => {\n        this.removeToast(id);\n      }, 5000);\n    },\n    removeToast(id) {\n      if (this.toasts) {\n        this.toasts = this.toasts.filter(toast => toast.id !== id);\n      }\n    },\n    ensureAbsoluteUrl(url) {\n      if (!url) return null;\n\n      // Log URL for debugging\n      console.log(`Resolving URL: ${url}`);\n\n      // Return as-is if already absolute or data URL\n      if (url.startsWith(\"http://\") || url.startsWith(\"https://\") || url.startsWith(\"data:\")) {\n        console.log(`URL is already absolute: ${url}`);\n        return url;\n      }\n\n      // Check if URL contains image_XXXXXXXX.png pattern (saved image format)\n      const imageFilenameMatch = url.match(/image_\\d+\\.png/);\n      if (imageFilenameMatch) {\n        // Extract filename\n        const filename = imageFilenameMatch[0];\n        console.log(`Detected image filename pattern: ${filename}`);\n        // Use correct endpoint /api/image/uploads/:fileName\n        const result = `${window.location.origin}/api/image/uploads/${filename}`;\n        console.log(`Created direct URL for image file: ${result}`);\n        return result;\n      }\n\n      // Special handling for uploads directory\n      if (url.includes(\"/uploads/\") || url.includes(\"uploads/\")) {\n        // Extract filename from path\n        const filename = url.split(\"/\").pop();\n        console.log(`Extracted filename from uploads path: ${filename}`);\n        // Use correct endpoint /api/image/uploads/:fileName\n        const result = `${window.location.origin}/api/image/uploads/${filename}`;\n        console.log(`Created uploads URL: ${result}`);\n        return result;\n      }\n\n      // If starts with /api, add domain\n      if (url.startsWith(\"/api\")) {\n        const result = `${window.location.origin}${url}`;\n        console.log(`Created API URL: ${result}`);\n        return result;\n      }\n\n      // If starts with server/ or /server/\n      if (url.startsWith(\"server/\") || url.startsWith(\"/server/\")) {\n        const result = `${window.location.origin}/api/${url.replace(/^(\\/)?server\\//, \"\")}`;\n        console.log(`Created server path URL: ${result}`);\n        return result;\n      }\n\n      // If doesn't start with / but is still a relative path, add /\n      if (!url.startsWith(\"/\")) {\n        const result = `${window.location.origin}/${url}`;\n        console.log(`Created relative path URL: ${result}`);\n        return result;\n      }\n\n      // Default case, assume relative to root\n      const result = `${window.location.origin}${url}`;\n      console.log(`Created root-relative URL: ${result}`);\n      return result;\n    },\n    handleImageError(event) {\n      console.error(\"Image loading error:\", event);\n      this.imageError = \"Failed to load image\";\n\n      // Try to debug and fix the image URL\n      if (this.localImage) {\n        this.debugImageUrl(this.localImage);\n      } else if (this.generatedImage) {\n        this.debugImageUrl(this.generatedImage);\n      }\n    },\n    debugImageUrl(originalUrl) {\n      console.log(\"Debugging image URL:\", originalUrl);\n\n      // Kiểm tra nhiều định dạng URL khác nhau\n      const possibleUrls = [];\n      if (typeof originalUrl !== \"string\") {\n        console.error(\"Original URL is not a string:\", originalUrl);\n        return;\n      }\n\n      // Lấy tên tệp nếu có\n      const filename = originalUrl.split(\"/\").pop();\n      console.log(\"Extracted filename:\", filename);\n\n      // Đường dẫn trực tiếp đến API endpoint (ưu tiên cao nhất)\n      if (filename) {\n        possibleUrls.push(`/api/image/uploads/${filename}`);\n        possibleUrls.push(`${window.location.origin}/api/image/uploads/${filename}`);\n      }\n      if (originalUrl.includes(\"uploads/\")) {\n        // Các định dạng khác cũng được thử\n        possibleUrls.push(`/server/uploads/${filename}`);\n        possibleUrls.push(`/uploads/${filename}`);\n      }\n\n      // Thử URL gốc với tên miền\n      if (!originalUrl.startsWith(\"http\") && !originalUrl.startsWith(\"data:\")) {\n        possibleUrls.push(`${window.location.origin}${originalUrl.startsWith(\"/\") ? \"\" : \"/\"}${originalUrl}`);\n      }\n\n      // Thêm URL gốc vào danh sách (nếu chưa có)\n      if (!possibleUrls.includes(originalUrl)) {\n        possibleUrls.push(originalUrl);\n      }\n      console.log(\"Trying alternate URLs:\", possibleUrls);\n\n      // Thử tải mỗi URL\n      let successFound = false;\n      possibleUrls.forEach((url, index) => {\n        setTimeout(() => {\n          // Skip if we already found a working URL\n          if (successFound) return;\n          const img = new Image();\n          img.onload = () => {\n            console.log(`Success with URL: ${url}`);\n            successFound = true;\n            this.localImage = url;\n            this.$emit(\"update:image\", url);\n            this.imageError = null;\n            this.imageLoading = false;\n          };\n          img.onerror = () => {\n            console.log(`Failed with URL: ${url}`);\n\n            // Nếu đây là URL cuối cùng và tất cả đều thất bại, hiển thị nút tạo hình ảnh mới\n            if (index === possibleUrls.length - 1 && !successFound) {\n              console.log(\"All URLs failed, showing generate button\");\n              this.imageError = \"Không thể tải hình ảnh. Bạn có thể tạo hình ảnh mới.\";\n            }\n          };\n          img.src = url;\n        }, index * 100);\n      });\n    },\n    handleImageLoad() {\n      console.log(\"Image loaded successfully\");\n      this.imageError = null;\n      this.imageLoading = false; // Ensure loading state is cleared\n    },\n    loadImageFromDatabase() {\n      if (!this.contentId) return;\n      this.imageLoading = true;\n      this.imageError = null;\n      console.log(`Fetching image data for content ID: ${this.contentId}`);\n\n      // Nếu có hình ảnh ở local state nhưng chưa được lưu vào database\n      if (this.localImage && this.localImage.startsWith(\"data:image\")) {\n        console.log(\"Found local base64 image, saving to database...\");\n        this.saveBase64ImageToServer(this.localImage);\n        return;\n      }\n      axios.get(`/api/content/contents/${this.contentId}`).then(response => {\n        if (response.data && response.data.success && response.data.data) {\n          const content = response.data.data;\n          console.log(\"Full content data from DB:\", content);\n          if (content.imageUrl) {\n            console.log(`Found image URL in database: ${content.imageUrl}`);\n\n            // Force reset error state\n            this.imageError = null;\n\n            // Check for image_XXXXXXXX.png pattern first (highest priority)\n            const imageFilenameMatch = content.imageUrl.match(/image_\\d+\\.png/);\n            if (imageFilenameMatch) {\n              const filename = imageFilenameMatch[0];\n              console.log(`Detected image filename pattern in database: ${filename}`);\n\n              // Create direct URL to image uploads endpoint\n              const directUrl = `${window.location.origin}/api/image/uploads/${filename}`;\n              console.log(\"Created direct URL to image from database:\", directUrl);\n\n              // Force update the image URL\n              this.localImage = directUrl;\n              this.$emit(\"update:image\", directUrl);\n\n              // Verify the image can be loaded\n              const img = new Image();\n              img.onload = () => {\n                console.log(\"Image loaded successfully using direct URL:\", directUrl);\n                this.imageError = null;\n                this.imageLoading = false;\n                this.showToast(\"Đã tải hình ảnh thành công\", \"success\");\n              };\n              img.onerror = err => {\n                console.error(\"Failed to load image with direct URL:\", err);\n                // Try one more time with a direct fetch to verify file exists\n                fetch(directUrl, {\n                  method: \"HEAD\"\n                }).then(response => {\n                  if (response.ok) {\n                    console.log(\"Image exists on server but failed to load. Trying again...\");\n                    // Force browser to reload the image by adding timestamp\n                    const timestamp = new Date().getTime();\n                    const urlWithCache = `${directUrl}?t=${timestamp}`;\n                    this.localImage = urlWithCache;\n                    this.$emit(\"update:image\", urlWithCache);\n                    this.imageLoading = false;\n                    this.showToast(\"Đã tải hình ảnh thành công\", \"success\");\n                  } else {\n                    throw new Error(`Server returned ${response.status}`);\n                  }\n                }).catch(fetchErr => {\n                  console.error(\"Image verification failed:\", fetchErr);\n                  this.imageError = \"Không thể tải hình ảnh từ server\";\n                  this.imageLoading = false;\n                  // Try debug as last resort\n                  this.debugImageUrl(content.imageUrl);\n                });\n              };\n              img.src = directUrl;\n              return;\n            }\n\n            // Try standard URL processing if no filename pattern\n            const formattedUrl = this.ensureAbsoluteUrl(content.imageUrl);\n            console.log(\"Formatted URL for image:\", formattedUrl);\n\n            // Verify the image can be loaded\n            const standardImg = new Image();\n            standardImg.onload = () => {\n              console.log(\"Image loaded successfully with formatted URL:\", formattedUrl);\n              this.localImage = formattedUrl;\n              this.$emit(\"update:image\", formattedUrl);\n              this.imageError = null;\n              this.imageLoading = false;\n              this.showToast(\"Đã tải hình ảnh thành công\", \"success\");\n            };\n            standardImg.onerror = () => {\n              console.error(\"Failed to load image with formatted URL\");\n              // Try fallback methods\n              this.tryAlternativeImageUrls(content.imageUrl);\n            };\n            standardImg.src = formattedUrl;\n          } else {\n            console.log(\"No image URL found in database\");\n\n            // Kiểm tra xem có generatedImage từ prop hoặc local state không\n            if (this.generatedImage || this.localImage) {\n              console.log(\"Using generatedImage or localImage instead\");\n              const imageToUse = this.localImage || this.generatedImage;\n\n              // Nếu là data URL, lưu vào database\n              if (typeof imageToUse === \"string\" && imageToUse.startsWith(\"data:image\")) {\n                console.log(\"Saving base64 image to database...\");\n                this.saveBase64ImageToServer(imageToUse);\n                return;\n              } else if (typeof imageToUse === \"object\" && imageToUse.image && imageToUse.image.startsWith(\"data:image\")) {\n                console.log(\"Saving object image.image to database...\");\n                this.saveBase64ImageToServer(imageToUse.image);\n                return;\n              }\n            } else {\n              this.localImage = null;\n              this.imageError = \"Không tìm thấy hình ảnh trong cơ sở dữ liệu\";\n              this.imageLoading = false;\n            }\n          }\n        } else {\n          console.error(\"Error fetching content:\", response.data);\n          this.imageError = \"Lỗi khi tải dữ liệu nội dung\";\n          this.imageLoading = false;\n        }\n      }).catch(error => {\n        console.error(\"Error fetching content:\", error);\n        this.imageError = `Lỗi kết nối: ${error.message}`;\n        this.imageLoading = false;\n      });\n    },\n    // Thêm hàm mới để thử các phương pháp thay thế khi tải hình ảnh\n    tryAlternativeImageUrls(originalUrl) {\n      try {\n        console.log(\"Trying alternative methods to load image:\", originalUrl);\n\n        // First, look for image_XXXXXXXX.png pattern\n        const imageFilenameMatch = originalUrl.match(/image_\\d+\\.png/);\n        if (imageFilenameMatch) {\n          const filename = imageFilenameMatch[0];\n          console.log(`Found image filename pattern: ${filename}`);\n\n          // Create direct URL to image uploads endpoint\n          const directUrl = `${window.location.origin}/api/image/uploads/${filename}`;\n          console.log(\"Created direct URL to image:\", directUrl);\n\n          // Update URL immediately\n          this.localImage = directUrl;\n          this.$emit(\"update:image\", directUrl);\n          this.imageLoading = false;\n\n          // Still try loading to confirm\n          const img = new Image();\n          img.onload = () => {\n            console.log(\"Image loaded successfully from direct URL\");\n            this.imageError = null;\n          };\n          img.onerror = () => {\n            console.error(\"Image failed to load from direct URL\");\n            this.imageError = \"Không thể tải hình ảnh từ server\";\n            this.debugImageUrl(originalUrl);\n          };\n          img.src = directUrl;\n          return;\n        }\n\n        // Try to load the original URL image first\n        const img = new Image();\n        img.onload = () => {\n          console.log(\"Image loaded successfully from original URL\");\n          this.localImage = originalUrl;\n          this.$emit(\"update:image\", originalUrl);\n          this.imageLoading = false;\n        };\n        img.onerror = async () => {\n          console.log(\"Failed to load image from original URL, trying alternate paths\");\n\n          // Try with /api prefix for server uploads\n          if (originalUrl.includes(\"uploads/\")) {\n            const uploadPathMatch = originalUrl.match(/(uploads\\/.*$)/);\n            if (uploadPathMatch && uploadPathMatch[1]) {\n              const apiUrl = `/api/image/${uploadPathMatch[1]}`;\n              console.log(\"Trying with API URL:\", apiUrl);\n\n              // Check if this URL works\n              const altImg = new Image();\n              altImg.onload = () => {\n                console.log(\"Image loaded successfully from API URL\");\n                this.localImage = apiUrl;\n                this.$emit(\"update:image\", apiUrl);\n                this.imageLoading = false;\n              };\n              altImg.onerror = () => {\n                console.log(\"Failed to load image from API URL\");\n\n                // Try one more time with absolute URL\n                const absoluteApiUrl = `${window.location.origin}${apiUrl}`;\n                console.log(\"Trying with absolute API URL:\", absoluteApiUrl);\n                const finalImg = new Image();\n                finalImg.onload = () => {\n                  console.log(\"Image loaded successfully from absolute API URL\");\n                  this.localImage = absoluteApiUrl;\n                  this.$emit(\"update:image\", absoluteApiUrl);\n                  this.imageLoading = false;\n                };\n                finalImg.onerror = () => {\n                  console.log(\"All API URL attempts failed\");\n                  this.imageError = \"Không thể tải hình ảnh từ server\";\n                  this.localImage = null;\n                  this.imageLoading = false;\n\n                  // Final attempt - debug URL\n                  this.debugImageUrl(originalUrl);\n                };\n                finalImg.src = absoluteApiUrl;\n              };\n              altImg.src = apiUrl;\n            } else {\n              this.imageError = \"Invalid image path format\";\n              this.localImage = null;\n              this.imageLoading = false;\n\n              // Final attempt - debug URL\n              this.debugImageUrl(originalUrl);\n            }\n          } else {\n            this.imageError = \"Image not found\";\n            this.localImage = null;\n            this.imageLoading = false;\n\n            // Final attempt - debug URL\n            this.debugImageUrl(originalUrl);\n          }\n        };\n\n        // Ensure the URL is properly formatted\n        img.src = this.ensureAbsoluteUrl(originalUrl);\n      } catch (imgError) {\n        console.error(\"Error checking image:\", imgError);\n        this.localImage = originalUrl;\n        this.$emit(\"update:image\", originalUrl);\n        this.imageLoading = false;\n      }\n    }\n  },\n  watch: {\n    generatedImage: {\n      immediate: true,\n      handler(newValue, oldValue) {\n        if (newValue !== oldValue) {\n          console.log(\"generatedImage changed:\", newValue);\n\n          // If we get a new generatedImage value, update localImage\n          if (newValue) {\n            this.localImage = newValue;\n          }\n          // Don't clear localImage if newValue is null - we may already have a valid image\n          // from fetchContentImage\n        }\n      }\n    },\n    contentId: {\n      immediate: true,\n      handler(newValue, oldValue) {\n        if (newValue && newValue !== oldValue) {\n          console.log(\"Content ID changed from\", oldValue, \"to\", newValue);\n\n          // Only clear localImage if we're switching to a different content\n          if (oldValue) {\n            this.localImage = null;\n          }\n\n          // Always fetch the image when contentId changes\n          this.fetchContentImage();\n\n          // Tải dữ liệu hình ảnh từ cơ sở dữ liệu\n          this.loadImageFromDatabase();\n        }\n      }\n    }\n  }\n};","map":{"version":3,"names":["axios","name","props","content","type","String","required","generatedImage","default","projectId","projectTitle","projectDescription","contentId","fromDashboard","Boolean","data","projectStatus","loading","error","saveLoading","saveMessage","saveStatus","imageLoading","imageError","localImage","toasts","computed","apiEndpoint","process","env","VUE_APP_API_URL","hasProjectId","length","hasContentId","formattedContent","formatted","replace","imageUrl","console","log","substring","ensureAbsoluteUrl","image","created","fetchProjectStatus","fetchContentImage","mounted","loadImageFromDatabase","methods","response","get","success","status","Error","contentImageUrl","testImg","Image","imageLoadPromise","Promise","resolve","onload","onerror","src","imageExists","contentImage","e","controller","AbortController","timeoutId","setTimeout","abort","signal","clearTimeout","contentData","includes","imageFilenameMatch","match","filename","directUrl","window","location","origin","originalUrl","warn","message","markAsFinished","alert","patch","markAsInProgress","saveContent","put","generatedContent","$emit","exportContent","exportData","title","createdAt","Date","toISOString","projectInfo","id","description","dataStr","JSON","stringify","blob","Blob","url","URL","createObjectURL","a","document","createElement","download","href","click","revokeObjectURL","shareContent","navigator","share","text","then","catch","clipboard","writeText","downloadPDF","goToDashboard","generateImageForContent","showToast","trim","promptResponse","post","style","template","timeout","generatedPrompt","prompt","imageResponse","width","height","num_inference_steps","startsWith","saveBase64ImageToServer","updateResponse","errorMessage","contentResponse","reloadError","base64Data","saveResponse","imageData","updateImageUrlToDatabase","now","push","removeToast","filter","toast","result","split","pop","handleImageError","event","debugImageUrl","possibleUrls","successFound","forEach","index","img","handleImageLoad","err","fetch","method","ok","timestamp","getTime","urlWithCache","fetchErr","formattedUrl","standardImg","tryAlternativeImageUrls","imageToUse","uploadPathMatch","apiUrl","altImg","absoluteApiUrl","finalImg","imgError","watch","immediate","handler","newValue","oldValue"],"sources":["/Users/nhannguyen/Desktop/Duan/esmart-solutions-agency/src/components/creator-ai/FinalStep.vue"],"sourcesContent":["<template>\n  <div class=\"step-content\">\n    <h2>Final Step</h2>\n    <div v-if=\"hasProjectId\" class=\"project-info\">\n      <h3>{{ projectTitle }}</h3>\n      <p v-if=\"projectDescription\">{{ projectDescription }}</p>\n      <div class=\"project-status\">\n        <span :class=\"['status-badge', projectStatus]\">\n          {{ projectStatus === \"in_progress\" ? \"In Progress\" : \"Finished\" }}\n        </span>\n        <button\n          v-if=\"projectStatus === 'in_progress'\"\n          class=\"status-button\"\n          @click=\"markAsFinished\"\n          :disabled=\"loading\"\n        >\n          {{ loading ? \"Updating...\" : \"Mark as Finished\" }}\n        </button>\n        <button\n          v-else\n          class=\"status-button\"\n          @click=\"markAsInProgress\"\n          :disabled=\"loading\"\n        >\n          {{ loading ? \"Updating...\" : \"Mark as In Progress\" }}\n        </button>\n      </div>\n      <p v-if=\"error\" class=\"error-message\">{{ error }}</p>\n    </div>\n    <div v-else class=\"project-info warning\">\n      <p>\n        This content is not saved to a project. Create a new project to save\n        your work.\n      </p>\n    </div>\n    <div class=\"final-content\">\n      <h3 class=\"mb-3\">Generated Content</h3>\n      <div v-if=\"loading\" class=\"d-flex justify-content-center\">\n        <div class=\"spinner-border text-primary\" role=\"status\">\n          <span class=\"visually-hidden\">Loading...</span>\n        </div>\n      </div>\n      <div v-else class=\"content-box\" v-html=\"formattedContent\"></div>\n    </div>\n\n    <div class=\"final-image-section\">\n      <h3>Generated Image</h3>\n      <div class=\"image-section\">\n        <div\n          v-if=\"imageLoading\"\n          class=\"d-flex justify-content-center align-items-center image-loading\"\n        >\n          <div class=\"spinner-border text-primary\" role=\"status\">\n            <span class=\"visually-hidden\">Loading...</span>\n          </div>\n          <p class=\"loading-text\">Loading image...</p>\n        </div>\n        <div v-else-if=\"imageError\" class=\"no-image-placeholder\">\n          <i class=\"fa-solid fa-triangle-exclamation fa-3x\"></i>\n          <p>{{ imageError }}</p>\n          <div class=\"image-error-actions\">\n            <button\n              v-if=\"hasContentId\"\n              @click=\"generateImageForContent\"\n              class=\"btn btn-primary mt-2\"\n            >\n              <i class=\"fa-solid fa-image\"></i> Tạo hình ảnh mới\n            </button>\n            <button\n              v-if=\"hasContentId\"\n              @click=\"loadImageFromDatabase\"\n              class=\"btn btn-secondary mt-2 ms-2\"\n            >\n              <i class=\"fa-solid fa-rotate\"></i> Tải lại hình ảnh\n            </button>\n          </div>\n        </div>\n        <img\n          v-else-if=\"imageUrl\"\n          :src=\"imageUrl\"\n          alt=\"Generated image\"\n          class=\"img-fluid rounded mb-3\"\n          @error=\"handleImageError\"\n          @load=\"handleImageLoad\"\n        />\n        <div v-else class=\"no-image-placeholder\">\n          <i class=\"fa-solid fa-image fa-5x\"></i>\n          <p>Không có hình ảnh</p>\n          <button\n            v-if=\"hasContentId\"\n            @click=\"generateImageForContent\"\n            class=\"btn btn-primary mt-3\"\n          >\n            <i class=\"fa-solid fa-image\"></i> Tạo hình ảnh\n          </button>\n        </div>\n\n        <div class=\"image-actions\">\n          <button\n            v-if=\"!imageLoading && !imageUrl && contentId\"\n            class=\"btn btn-success mt-2\"\n            @click=\"generateImageForContent\"\n          >\n            <i class=\"fas fa-magic me-1\"></i>\n            Generate Image\n          </button>\n        </div>\n      </div>\n    </div>\n\n    <div class=\"final-actions\">\n      <div class=\"action-buttons\">\n        <div class=\"additional-actions\">\n          <button class=\"btn btn-outline-primary\" @click=\"exportContent\">\n            <i class=\"fas fa-file-export me-1\"></i>\n            Export\n          </button>\n          <button class=\"btn btn-outline-primary\" @click=\"shareContent\">\n            <i class=\"fas fa-share-alt me-1\"></i>\n            Share\n          </button>\n          <button class=\"btn btn-outline-primary\" @click=\"downloadPDF\">\n            <i class=\"fas fa-file-pdf me-1\"></i>\n            Download PDF\n          </button>\n        </div>\n      </div>\n      <div class=\"navigation-buttons\">\n        <button\n          v-if=\"!fromDashboard\"\n          class=\"btn btn-light\"\n          @click=\"$emit('prev')\"\n        >\n          <i class=\"fas fa-arrow-left me-1\"></i>\n          Previous Step\n        </button>\n        <button v-else class=\"btn btn-light\" @click=\"$emit('go-to-dashboard')\">\n          <i class=\"fas fa-home me-1\"></i>\n          Back to Dashboard\n        </button>\n        <button class=\"btn btn-info\" @click=\"$emit('go-to-dashboard')\">\n          <i class=\"fas fa-home me-1\"></i>\n          Dashboard\n        </button>\n        <button class=\"btn btn-success\" @click=\"$emit('new')\">\n          <i class=\"fas fa-plus me-1\"></i>\n          Create New\n        </button>\n      </div>\n    </div>\n    <div v-if=\"saveMessage\" :class=\"['save-message', saveStatus]\">\n      {{ saveMessage }}\n    </div>\n\n    <!-- Toast Messages Container -->\n    <div class=\"toast-container\">\n      <div\n        v-for=\"toast in toasts\"\n        :key=\"toast.id\"\n        :class=\"['toast-message', `toast-${toast.type}`]\"\n        @click=\"removeToast(toast.id)\"\n      >\n        <span>{{ toast.message }}</span>\n        <button class=\"toast-close-btn\">&times;</button>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport axios from \"axios\";\n\nexport default {\n  name: \"FinalStep\",\n  props: {\n    content: {\n      type: String,\n      required: true,\n    },\n    generatedImage: {\n      type: String,\n      default: null,\n    },\n    projectId: {\n      type: String,\n      default: \"\",\n    },\n    projectTitle: {\n      type: String,\n      default: \"Content Project\",\n    },\n    projectDescription: {\n      type: String,\n      default: \"\",\n    },\n    contentId: {\n      type: String,\n      default: \"\",\n    },\n    fromDashboard: {\n      type: Boolean,\n      default: false,\n    },\n  },\n  data() {\n    return {\n      projectStatus: \"in_progress\",\n      loading: false,\n      error: null,\n      saveLoading: false,\n      saveMessage: null,\n      saveStatus: \"success\",\n      imageLoading: false,\n      imageError: null,\n      localImage: this.generatedImage,\n      toasts: [],\n    };\n  },\n  computed: {\n    apiEndpoint() {\n      return process.env.VUE_APP_API_URL || \"http://localhost:3001/api\";\n    },\n    hasProjectId() {\n      return this.projectId && this.projectId.length > 0;\n    },\n    hasContentId() {\n      return this.contentId && this.contentId.length > 0;\n    },\n    formattedContent() {\n      if (!this.content) return \"\";\n\n      // Tạo định dạng HTML cho nội dung\n      const formatted = this.content\n        // Thay thế dòng trống bằng thẻ đoạn\n        .replace(/\\n\\s*\\n/g, \"</p><p>\")\n        // Thay thế dòng mới đơn bằng thẻ br\n        .replace(/\\n/g, \"<br>\")\n        // Bọc toàn bộ nội dung trong thẻ p\n        .replace(/^(.+)$/, \"<p>$1</p>\");\n\n      return formatted;\n    },\n    imageUrl() {\n      // First, use localImage from data if available\n      if (this.localImage) {\n        console.log(\n          \"Using local image:\",\n          this.localImage.substring(0, 50) + \"...\"\n        );\n\n        // Ensure the URL is properly formatted for deployment\n        return this.ensureAbsoluteUrl(this.localImage);\n      }\n\n      // Next, try to use generated image from props\n      if (this.generatedImage) {\n        console.log(\n          \"Using generated image from props:\",\n          typeof this.generatedImage === \"string\"\n            ? this.generatedImage.substring(0, 50) + \"...\"\n            : \"object\"\n        );\n\n        // Handle string URLs (including data URLs)\n        if (typeof this.generatedImage === \"string\") {\n          return this.ensureAbsoluteUrl(this.generatedImage);\n        }\n\n        // Handle object format\n        if (\n          typeof this.generatedImage === \"object\" &&\n          this.generatedImage !== null\n        ) {\n          if (\"image\" in this.generatedImage) {\n            return this.ensureAbsoluteUrl(this.generatedImage.image);\n          }\n          if (\"imageUrl\" in this.generatedImage) {\n            return this.ensureAbsoluteUrl(this.generatedImage.imageUrl);\n          }\n        }\n      }\n\n      return null;\n    },\n  },\n  created() {\n    console.log(\"FinalStep created\");\n    console.log(\"generatedImage prop:\", this.generatedImage);\n    console.log(\"contentId prop:\", this.contentId);\n\n    // Set initial local image from props\n    if (this.generatedImage) {\n      this.localImage = this.generatedImage;\n    } else {\n      this.localImage = null;\n    }\n\n    if (this.hasProjectId) {\n      this.fetchProjectStatus();\n    }\n\n    // Always fetch content image if we have contentId, regardless of generatedImage prop\n    if (this.hasContentId) {\n      this.fetchContentImage();\n    }\n  },\n  mounted() {\n    console.log(\"FinalStep mounted, contentId:\", this.contentId);\n    console.log(\"From dashboard:\", this.fromDashboard);\n    console.log(\"Generated image from props:\", !!this.generatedImage);\n\n    // Thêm giá trị mặc định cho toasts\n    if (!this.toasts) {\n      this.toasts = [];\n    }\n\n    // Tải lại dữ liệu hình ảnh từ cơ sở dữ liệu nếu có contentId\n    if (this.contentId && (!this.generatedImage || this.fromDashboard)) {\n      console.log(\"Loading image data from database...\");\n      this.loadImageFromDatabase();\n    }\n  },\n  methods: {\n    async fetchProjectStatus() {\n      try {\n        if (!this.hasProjectId) return;\n\n        const response = await axios.get(\n          `${this.apiEndpoint}/projects/${this.projectId}`\n        );\n        if (response.data.success) {\n          this.projectStatus = response.data.data.status;\n        }\n      } catch (error) {\n        console.error(\"Error fetching project status:\", error);\n        this.error = \"Could not fetch project status\";\n      }\n    },\n    async fetchContentImage() {\n      this.imageLoading = true;\n      this.imageError = false;\n\n      try {\n        console.log(\"Fetching content image...\");\n\n        if (!this.contentId) {\n          console.error(\"No content ID available\");\n          throw new Error(\"Không có ID nội dung để tải hình ảnh\");\n        }\n\n        // Ưu tiên sử dụng endpoint content-image để lấy ảnh từ database\n        const contentImageUrl = `/api/image/content-image/${this.contentId}`;\n        console.log(`Trying content-image endpoint: ${contentImageUrl}`);\n\n        try {\n          // Kiểm tra xem ảnh có tồn tại trong database không\n          const testImg = new Image();\n          const imageLoadPromise = new Promise((resolve) => {\n            testImg.onload = () => resolve(true);\n            testImg.onerror = () => resolve(false);\n          });\n\n          testImg.src = contentImageUrl;\n          const imageExists = await imageLoadPromise;\n\n          if (imageExists) {\n            console.log(\n              \"Image exists in database, using content-image endpoint\"\n            );\n            this.imageUrl = this.ensureAbsoluteUrl(contentImageUrl);\n            this.contentImage = this.imageUrl;\n            this.imageLoading = false;\n            return;\n          }\n        } catch (e) {\n          console.log(\"Error checking content-image endpoint:\", e);\n        }\n\n        console.log(\"Image not found in database, checking content record\");\n\n        // Nếu không tìm thấy trong database, thì kiểm tra từ API\n        const controller = new AbortController();\n        const timeoutId = setTimeout(() => controller.abort(), 10000);\n\n        const response = await axios.get(\n          `/api/content/contents/${this.contentId}`,\n          {\n            signal: controller.signal,\n          }\n        );\n\n        clearTimeout(timeoutId);\n\n        if (response.data && response.data.success) {\n          const contentData = response.data.data;\n          console.log(\"Full content data:\", contentData);\n\n          if (contentData && contentData.imageUrl) {\n            console.log(\n              `Found image URL for content ${this.contentId}:`,\n              contentData.imageUrl\n            );\n\n            // Check for content-image endpoint first (highest priority)\n            if (contentData.imageUrl.includes(\"/content-image/\")) {\n              const imageUrl = this.ensureAbsoluteUrl(contentData.imageUrl);\n              console.log(`Using content-image URL: ${imageUrl}`);\n              this.imageUrl = imageUrl;\n              this.contentImage = imageUrl;\n              this.imageLoading = false;\n              return;\n            }\n\n            // Check filename pattern next\n            const imageFilenameMatch =\n              contentData.imageUrl.match(/image_\\d+\\.png/);\n            if (imageFilenameMatch) {\n              const filename = imageFilenameMatch[0];\n              console.log(\n                `Detected image filename pattern directly in content data: ${filename}`\n              );\n\n              // Create absolute URL to image uploads endpoint\n              const directUrl = `${window.location.origin}/api/image/uploads/${filename}`;\n              console.log(\"Created direct URL to image:\", directUrl);\n\n              this.imageUrl = directUrl;\n              this.contentImage = directUrl;\n              this.imageLoading = false;\n              return;\n            }\n\n            // Kiểm tra đường dẫn hình ảnh\n            if (\n              contentData.imageUrl.includes(\"undefined\") ||\n              contentData.imageUrl === \"null\" ||\n              contentData.imageUrl === \"\"\n            ) {\n              console.error(\n                \"Invalid image URL detected:\",\n                contentData.imageUrl\n              );\n              this.imageError = \"URL hình ảnh không hợp lệ\";\n              this.imageLoading = false;\n              return;\n            }\n\n            // Store the original URL\n            const originalUrl = contentData.imageUrl;\n            console.log(\"Original image URL:\", originalUrl);\n\n            // Use the original URL with proper handling\n            this.imageUrl = this.ensureAbsoluteUrl(originalUrl);\n            this.contentImage = this.imageUrl;\n            this.imageLoading = false;\n          } else {\n            console.log(`No image found for content ${this.contentId}`);\n            this.imageUrl = null;\n            this.imageLoading = false;\n            this.imageError = \"Không tìm thấy hình ảnh trong cơ sở dữ liệu\";\n          }\n        } else {\n          console.warn(\"API did not return success:\", response.data);\n          this.imageUrl = null;\n          this.imageLoading = false;\n          this.imageError = \"Lỗi khi lấy dữ liệu nội dung\";\n        }\n      } catch (error) {\n        console.error(\"Error in fetchContentImage:\", error);\n\n        if (error.name === \"AbortError\") {\n          this.imageError = \"Request timed out when loading image\";\n        } else {\n          this.imageError = \"Failed to load image: \" + error.message;\n        }\n\n        this.imageUrl = null;\n        this.imageLoading = false;\n      }\n    },\n    async markAsFinished() {\n      try {\n        if (!this.hasProjectId) {\n          alert(\"Cannot update status: No project ID available\");\n          return;\n        }\n\n        this.loading = true;\n        const response = await axios.patch(\n          `${this.apiEndpoint}/projects/${this.projectId}/status`,\n          {\n            status: \"finished\",\n          }\n        );\n\n        if (response.data.success) {\n          this.projectStatus = \"finished\";\n        }\n      } catch (error) {\n        console.error(\"Error updating project status:\", error);\n        alert(\"Failed to update project status: \" + error.message);\n      } finally {\n        this.loading = false;\n      }\n    },\n    async markAsInProgress() {\n      try {\n        if (!this.hasProjectId) {\n          alert(\"Cannot update status: No project ID available\");\n          return;\n        }\n\n        this.loading = true;\n        const response = await axios.patch(\n          `${this.apiEndpoint}/projects/${this.projectId}/status`,\n          {\n            status: \"in_progress\",\n          }\n        );\n\n        if (response.data.success) {\n          this.projectStatus = \"in_progress\";\n        }\n      } catch (error) {\n        console.error(\"Error updating project status:\", error);\n        alert(\"Failed to update project status: \" + error.message);\n      } finally {\n        this.loading = false;\n      }\n    },\n    async saveContent() {\n      try {\n        if (!this.hasContentId) {\n          this.saveMessage = \"No content ID available. Cannot save.\";\n          this.saveStatus = \"error\";\n          return;\n        }\n\n        this.saveLoading = true;\n        this.saveMessage = null;\n\n        const response = await axios.put(\n          `${this.apiEndpoint}/content/contents/${this.contentId}`,\n          {\n            generatedContent: this.content,\n          }\n        );\n\n        if (response.data.success) {\n          this.saveMessage = \"Content saved successfully!\";\n          this.saveStatus = \"success\";\n          // Emit event to update parent content\n          this.$emit(\"update:content\", this.content);\n        } else {\n          throw new Error(response.data.error || \"Unknown error occurred\");\n        }\n      } catch (error) {\n        console.error(\"Error saving content:\", error);\n        this.saveMessage = \"Failed to save content: \" + error.message;\n        this.saveStatus = \"error\";\n      } finally {\n        this.saveLoading = false;\n\n        // Clear message after 3 seconds\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n      }\n    },\n    exportContent() {\n      try {\n        // Tạo dữ liệu để export\n        const exportData = {\n          title: this.projectTitle || \"Untitled Content\",\n          content: this.content,\n          image: this.imageUrl,\n          createdAt: new Date().toISOString(),\n          projectInfo: {\n            id: this.projectId,\n            title: this.projectTitle,\n            description: this.projectDescription,\n          },\n        };\n\n        // Tạo JSON string\n        const dataStr = JSON.stringify(exportData, null, 2);\n\n        // Tạo blob để download\n        const blob = new Blob([dataStr], { type: \"application/json\" });\n        const url = URL.createObjectURL(blob);\n\n        // Tạo link và kích hoạt download\n        const a = document.createElement(\"a\");\n        a.download = `${this.projectTitle || \"content\"}_export.json`;\n        a.href = url;\n        a.click();\n\n        // Giải phóng URL object\n        URL.revokeObjectURL(url);\n\n        this.saveMessage = \"Content exported successfully!\";\n        this.saveStatus = \"success\";\n\n        // Clear message after 3 seconds\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n      } catch (error) {\n        console.error(\"Error exporting content:\", error);\n        this.saveMessage = \"Failed to export content: \" + error.message;\n        this.saveStatus = \"error\";\n\n        // Clear message after 3 seconds\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n      }\n    },\n    shareContent() {\n      // Xử lý chia sẻ nội dung - có thể thông qua email hoặc mạng xã hội\n      try {\n        // Kiểm tra nếu Web Share API được hỗ trợ\n        if (navigator.share) {\n          navigator\n            .share({\n              title: this.projectTitle || \"My Content\",\n              text: `Check out my content: ${this.projectTitle || \"Content\"}`,\n              url: window.location.href,\n            })\n            .then(() => {\n              this.saveMessage = \"Content shared successfully!\";\n              this.saveStatus = \"success\";\n            })\n            .catch((error) => {\n              throw error;\n            });\n        } else {\n          // Fallback - copy URL vào clipboard\n          navigator.clipboard.writeText(window.location.href).then(() => {\n            this.saveMessage = \"URL copied to clipboard!\";\n            this.saveStatus = \"success\";\n          });\n        }\n\n        // Clear message after 3 seconds\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n      } catch (error) {\n        console.error(\"Error sharing content:\", error);\n        this.saveMessage = \"Failed to share content: \" + error.message;\n        this.saveStatus = \"error\";\n\n        // Clear message after 3 seconds\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n      }\n    },\n    downloadPDF() {\n      try {\n        // Thông báo cho người dùng rằng chức năng đang được phát triển\n        this.saveMessage = \"PDF download feature will be available soon.\";\n        this.saveStatus = \"success\";\n\n        // Xóa thông báo sau 3 giây\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n\n        // NOTE: Chức năng này sẽ được triển khai trong bản cập nhật tới\n        // Sử dụng thư viện như jsPDF hoặc html2pdf.js để tạo PDF từ nội dung\n      } catch (error) {\n        console.error(\"Error downloading PDF:\", error);\n        this.saveMessage = \"Failed to download PDF: \" + error.message;\n        this.saveStatus = \"error\";\n\n        // Clear message after 3 seconds\n        setTimeout(() => {\n          this.saveMessage = null;\n        }, 3000);\n      }\n    },\n    goToDashboard() {\n      this.$emit(\"go-to-dashboard\");\n    },\n    async generateImageForContent() {\n      try {\n        this.imageLoading = true;\n        this.imageError = null;\n\n        // Hiển thị thông báo đang xử lý\n        this.showToast(\"Đang chuẩn bị tạo hình ảnh cho nội dung...\", \"info\");\n\n        if (!this.contentId) {\n          throw new Error(\"Không có ID nội dung để tạo hình ảnh\");\n        }\n\n        // Kiểm tra xem có nội dung không\n        if (!this.content || this.content.trim().length === 0) {\n          this.showToast(\"Không thể tạo hình ảnh: Nội dung trống\", \"error\");\n          throw new Error(\"Nội dung trống, không thể tạo hình ảnh\");\n        }\n\n        console.log(`Generating image for content ID: ${this.contentId}`);\n        console.log(`Content length: ${this.content.length} characters`);\n\n        // Bước 1: Tạo prompt từ nội dung\n        console.log(\"Step 1: Generating prompt from content\");\n        const promptResponse = await axios.post(\n          `/api/content/contents/generate-prompt`,\n          {\n            contentId: this.contentId,\n            style: \"Realistic\",\n            template: `Generate a [STYLE] image of [SUBJECT], featuring [KEY DETAILS]. Style: [ART STYLE/MEDIUM], color palette: [COLORS], lighting: [LIGHTING], composition: [COMPOSITION]. Additional effects: [EFFECTS]. Keep the overall mood [MOOD]. Render in Kandinsky 2.2 with high detail, resolution [RESOLUTION].`,\n            content: this.content,\n          },\n          {\n            timeout: 45000, // 45 seconds timeout for prompt generation\n          }\n        );\n\n        if (!promptResponse.data.success) {\n          throw new Error(\n            promptResponse.data.error || \"Lỗi khi tạo mô tả hình ảnh\"\n          );\n        }\n\n        const generatedPrompt = promptResponse.data.prompt;\n        console.log(\n          \"Generated prompt:\",\n          generatedPrompt.substring(0, 100) + \"...\"\n        );\n\n        // Hiển thị thông báo prompt đã được tạo\n        this.showToast(\n          \"Đã tạo mô tả hình ảnh, đang tạo hình ảnh...\",\n          \"success\"\n        );\n\n        // Bước 2: Tạo hình ảnh từ prompt\n        const imageResponse = await axios.post(\n          `/api/image/generate`,\n          {\n            prompt: generatedPrompt,\n            style: \"Realistic\",\n            width: 512,\n            height: 512,\n            num_inference_steps: 30,\n          },\n          {\n            timeout: 180000, // 3 minutes timeout for image generation\n          }\n        );\n\n        if (!imageResponse.data.success) {\n          throw new Error(\n            imageResponse.data.error || \"Lỗi khi tạo hình ảnh từ mô tả\"\n          );\n        }\n\n        // Kiểm tra nếu response có chứa dữ liệu hình ảnh dạng base64\n        if (\n          imageResponse.data.image &&\n          imageResponse.data.image.startsWith(\"data:image\")\n        ) {\n          console.log(\"Received base64 image data from API\");\n\n          // Save base64 image to server and get URL\n          await this.saveBase64ImageToServer(imageResponse.data.image);\n          return;\n        }\n\n        // Trường hợp API trả về filename\n        const imageUrl = `/api/content/contents/${this.contentId}/images/${imageResponse.data.filename}`;\n\n        // Bước 3: Cập nhật URL hình ảnh vào nội dung\n        const updateResponse = await axios.put(\n          `/api/content/contents/${this.contentId}`,\n          {\n            imageUrl,\n            generatedContent: this.content, // Thêm trường generatedContent để tránh lỗi\n          }\n        );\n\n        if (!updateResponse.data.success) {\n          throw new Error(\n            updateResponse.data.error || \"Lỗi khi cập nhật URL hình ảnh\"\n          );\n        }\n\n        // Cập nhật URL hình ảnh vào local state\n        this.localImage = imageUrl;\n        this.$emit(\"update:image\", imageUrl);\n\n        // Hiển thị thông báo thành công\n        this.showToast(\"Đã tạo hình ảnh thành công!\", \"success\");\n      } catch (error) {\n        console.error(\"Error generating image for content:\", error);\n\n        let errorMessage = \"Lỗi không xác định\";\n\n        // Check for API response error\n        if (error.response) {\n          console.log(\"API response error:\", error.response.data);\n\n          // Handle specific error messages from server\n          if (error.response.data && error.response.data.error) {\n            errorMessage = error.response.data.error;\n\n            // Specific checks for common errors\n            if (errorMessage.includes(\"Missing required field\")) {\n              errorMessage =\n                \"Thiếu trường dữ liệu cần thiết. Vui lòng thử lại.\";\n              console.log(\"Content availability:\", !!this.content);\n              console.log(\"ContentId availability:\", !!this.contentId);\n\n              // Try retrieving the content again if missing\n              if (\n                this.contentId &&\n                (!this.content || this.content.trim().length === 0)\n              ) {\n                this.showToast(\"Đang thử tải lại nội dung...\", \"info\");\n                try {\n                  const contentResponse = await axios.get(\n                    `/api/content/contents/${this.contentId}`\n                  );\n                  if (\n                    contentResponse.data.success &&\n                    contentResponse.data.data.generatedContent\n                  ) {\n                    // Update the local content\n                    this.$emit(\n                      \"update:content\",\n                      contentResponse.data.data.generatedContent\n                    );\n                    this.showToast(\n                      \"Đã tải lại nội dung, vui lòng thử lại\",\n                      \"info\"\n                    );\n                  }\n                } catch (reloadError) {\n                  console.error(\"Error reloading content:\", reloadError);\n                }\n              }\n            }\n          }\n        } else if (error.message) {\n          errorMessage = error.message;\n        }\n\n        this.imageError = `Lỗi khi tạo hình ảnh: ${errorMessage}`;\n\n        // Hiển thị thông báo lỗi\n        this.showToast(`Lỗi: ${errorMessage}`, \"error\");\n\n        // Nếu lỗi do timeout\n        if (error.message.includes(\"timeout\")) {\n          this.showToast(\n            \"Quá thời gian chờ phản hồi. Vui lòng thử lại sau.\",\n            \"error\"\n          );\n        }\n      } finally {\n        this.imageLoading = false;\n      }\n    },\n    async saveBase64ImageToServer(base64Data) {\n      try {\n        console.log(\"Saving base64 image to server...\");\n        if (!this.contentId) {\n          throw new Error(\"No content ID available\");\n        }\n\n        // Hiển thị thông báo đang xử lý\n        this.showToast(\"Đang lưu hình ảnh vào máy chủ...\", \"info\");\n\n        // 1. Gửi dữ liệu base64 đến API để lưu trên server\n        const saveResponse = await axios.post(\"/api/image/save-base64\", {\n          imageData: base64Data,\n          contentId: this.contentId,\n        });\n\n        if (!saveResponse.data.success) {\n          throw new Error(saveResponse.data.error || \"Lỗi khi lưu hình ảnh\");\n        }\n\n        // 2. Lấy URL của hình ảnh đã lưu\n        const imageUrl = saveResponse.data.imageUrl;\n        console.log(\"Image saved successfully, URL:\", imageUrl);\n\n        // 3. Cập nhật URL hình ảnh vào content\n        const updateResponse = await axios.patch(\n          `/api/content/contents/${this.contentId}/partial`,\n          { imageUrl }\n        );\n\n        if (!updateResponse.data.success) {\n          throw new Error(\n            updateResponse.data.error || \"Lỗi khi cập nhật URL hình ảnh\"\n          );\n        }\n\n        // 4. Cập nhật URL hình ảnh vào local state\n        this.localImage = imageUrl;\n        this.$emit(\"update:image\", imageUrl);\n\n        // Hiển thị thông báo thành công\n        this.showToast(\"Đã lưu hình ảnh thành công!\", \"success\");\n        this.imageError = null;\n      } catch (error) {\n        console.error(\"Error saving base64 image:\", error);\n\n        // Nếu đã có dữ liệu base64, vẫn hiển thị dù không lưu được\n        if (base64Data) {\n          this.localImage = base64Data;\n          this.$emit(\"update:image\", base64Data);\n          this.showToast(\n            \"Hiển thị hình ảnh tạm thời. Không thể lưu vào máy chủ.\",\n            \"warning\"\n          );\n        } else {\n          this.imageError =\n            \"Không thể lưu hình ảnh vào máy chủ: \" + error.message;\n          this.showToast(\"Lỗi: \" + error.message, \"error\");\n        }\n      }\n    },\n    async updateImageUrlToDatabase() {\n      try {\n        // Kiểm tra xem có imageUrl trong local state không\n        if (!this.localImage || !this.contentId) {\n          console.error(\"Không có dữ liệu hình ảnh hoặc ID nội dung\");\n          return;\n        }\n\n        this.imageLoading = true;\n        this.showToast(\"Đang cập nhật hình ảnh vào cơ sở dữ liệu...\", \"info\");\n\n        // Lấy thông tin nội dung hiện tại\n        const contentResponse = await axios.get(\n          `/api/content/contents/${this.contentId}`\n        );\n        if (!contentResponse.data.success) {\n          throw new Error(\"Không thể lấy thông tin nội dung\");\n        }\n\n        const content = contentResponse.data.data;\n\n        // Nếu là data URL, cần lưu vào server trước\n        if (this.localImage.startsWith(\"data:image\")) {\n          await this.saveBase64ImageToServer(this.localImage);\n          return;\n        }\n\n        // Cập nhật URL\n        const updateResponse = await axios.put(\n          `/api/content/contents/${this.contentId}`,\n          {\n            imageUrl: this.localImage,\n            generatedContent: content.generatedContent || this.content,\n          }\n        );\n\n        if (!updateResponse.data.success) {\n          throw new Error(\n            updateResponse.data.error || \"Lỗi khi cập nhật URL hình ảnh\"\n          );\n        }\n\n        this.showToast(\"Đã cập nhật hình ảnh vào cơ sở dữ liệu!\", \"success\");\n      } catch (error) {\n        console.error(\"Error updating image URL:\", error);\n        this.showToast(\"Lỗi: \" + error.message, \"error\");\n      } finally {\n        this.imageLoading = false;\n      }\n    },\n    showToast(message, type = \"info\") {\n      if (!this.toasts) this.toasts = [];\n\n      const id = Date.now();\n      this.toasts.push({ id, message, type });\n\n      // Tự động xóa sau 5 giây\n      setTimeout(() => {\n        this.removeToast(id);\n      }, 5000);\n    },\n    removeToast(id) {\n      if (this.toasts) {\n        this.toasts = this.toasts.filter((toast) => toast.id !== id);\n      }\n    },\n    ensureAbsoluteUrl(url) {\n      if (!url) return null;\n\n      // Log URL for debugging\n      console.log(`Resolving URL: ${url}`);\n\n      // Return as-is if already absolute or data URL\n      if (\n        url.startsWith(\"http://\") ||\n        url.startsWith(\"https://\") ||\n        url.startsWith(\"data:\")\n      ) {\n        console.log(`URL is already absolute: ${url}`);\n        return url;\n      }\n\n      // Check if URL contains image_XXXXXXXX.png pattern (saved image format)\n      const imageFilenameMatch = url.match(/image_\\d+\\.png/);\n      if (imageFilenameMatch) {\n        // Extract filename\n        const filename = imageFilenameMatch[0];\n        console.log(`Detected image filename pattern: ${filename}`);\n        // Use correct endpoint /api/image/uploads/:fileName\n        const result = `${window.location.origin}/api/image/uploads/${filename}`;\n        console.log(`Created direct URL for image file: ${result}`);\n        return result;\n      }\n\n      // Special handling for uploads directory\n      if (url.includes(\"/uploads/\") || url.includes(\"uploads/\")) {\n        // Extract filename from path\n        const filename = url.split(\"/\").pop();\n        console.log(`Extracted filename from uploads path: ${filename}`);\n        // Use correct endpoint /api/image/uploads/:fileName\n        const result = `${window.location.origin}/api/image/uploads/${filename}`;\n        console.log(`Created uploads URL: ${result}`);\n        return result;\n      }\n\n      // If starts with /api, add domain\n      if (url.startsWith(\"/api\")) {\n        const result = `${window.location.origin}${url}`;\n        console.log(`Created API URL: ${result}`);\n        return result;\n      }\n\n      // If starts with server/ or /server/\n      if (url.startsWith(\"server/\") || url.startsWith(\"/server/\")) {\n        const result = `${window.location.origin}/api/${url.replace(\n          /^(\\/)?server\\//,\n          \"\"\n        )}`;\n        console.log(`Created server path URL: ${result}`);\n        return result;\n      }\n\n      // If doesn't start with / but is still a relative path, add /\n      if (!url.startsWith(\"/\")) {\n        const result = `${window.location.origin}/${url}`;\n        console.log(`Created relative path URL: ${result}`);\n        return result;\n      }\n\n      // Default case, assume relative to root\n      const result = `${window.location.origin}${url}`;\n      console.log(`Created root-relative URL: ${result}`);\n      return result;\n    },\n    handleImageError(event) {\n      console.error(\"Image loading error:\", event);\n      this.imageError = \"Failed to load image\";\n\n      // Try to debug and fix the image URL\n      if (this.localImage) {\n        this.debugImageUrl(this.localImage);\n      } else if (this.generatedImage) {\n        this.debugImageUrl(this.generatedImage);\n      }\n    },\n    debugImageUrl(originalUrl) {\n      console.log(\"Debugging image URL:\", originalUrl);\n\n      // Kiểm tra nhiều định dạng URL khác nhau\n      const possibleUrls = [];\n\n      if (typeof originalUrl !== \"string\") {\n        console.error(\"Original URL is not a string:\", originalUrl);\n        return;\n      }\n\n      // Lấy tên tệp nếu có\n      const filename = originalUrl.split(\"/\").pop();\n      console.log(\"Extracted filename:\", filename);\n\n      // Đường dẫn trực tiếp đến API endpoint (ưu tiên cao nhất)\n      if (filename) {\n        possibleUrls.push(`/api/image/uploads/${filename}`);\n        possibleUrls.push(\n          `${window.location.origin}/api/image/uploads/${filename}`\n        );\n      }\n\n      if (originalUrl.includes(\"uploads/\")) {\n        // Các định dạng khác cũng được thử\n        possibleUrls.push(`/server/uploads/${filename}`);\n        possibleUrls.push(`/uploads/${filename}`);\n      }\n\n      // Thử URL gốc với tên miền\n      if (!originalUrl.startsWith(\"http\") && !originalUrl.startsWith(\"data:\")) {\n        possibleUrls.push(\n          `${window.location.origin}${\n            originalUrl.startsWith(\"/\") ? \"\" : \"/\"\n          }${originalUrl}`\n        );\n      }\n\n      // Thêm URL gốc vào danh sách (nếu chưa có)\n      if (!possibleUrls.includes(originalUrl)) {\n        possibleUrls.push(originalUrl);\n      }\n\n      console.log(\"Trying alternate URLs:\", possibleUrls);\n\n      // Thử tải mỗi URL\n      let successFound = false;\n\n      possibleUrls.forEach((url, index) => {\n        setTimeout(() => {\n          // Skip if we already found a working URL\n          if (successFound) return;\n\n          const img = new Image();\n          img.onload = () => {\n            console.log(`Success with URL: ${url}`);\n            successFound = true;\n            this.localImage = url;\n            this.$emit(\"update:image\", url);\n            this.imageError = null;\n            this.imageLoading = false;\n          };\n          img.onerror = () => {\n            console.log(`Failed with URL: ${url}`);\n\n            // Nếu đây là URL cuối cùng và tất cả đều thất bại, hiển thị nút tạo hình ảnh mới\n            if (index === possibleUrls.length - 1 && !successFound) {\n              console.log(\"All URLs failed, showing generate button\");\n              this.imageError =\n                \"Không thể tải hình ảnh. Bạn có thể tạo hình ảnh mới.\";\n            }\n          };\n          img.src = url;\n        }, index * 100);\n      });\n    },\n    handleImageLoad() {\n      console.log(\"Image loaded successfully\");\n      this.imageError = null;\n      this.imageLoading = false; // Ensure loading state is cleared\n    },\n    loadImageFromDatabase() {\n      if (!this.contentId) return;\n\n      this.imageLoading = true;\n      this.imageError = null;\n\n      console.log(`Fetching image data for content ID: ${this.contentId}`);\n\n      // Nếu có hình ảnh ở local state nhưng chưa được lưu vào database\n      if (this.localImage && this.localImage.startsWith(\"data:image\")) {\n        console.log(\"Found local base64 image, saving to database...\");\n        this.saveBase64ImageToServer(this.localImage);\n        return;\n      }\n\n      axios\n        .get(`/api/content/contents/${this.contentId}`)\n        .then((response) => {\n          if (response.data && response.data.success && response.data.data) {\n            const content = response.data.data;\n            console.log(\"Full content data from DB:\", content);\n\n            if (content.imageUrl) {\n              console.log(`Found image URL in database: ${content.imageUrl}`);\n\n              // Force reset error state\n              this.imageError = null;\n\n              // Check for image_XXXXXXXX.png pattern first (highest priority)\n              const imageFilenameMatch =\n                content.imageUrl.match(/image_\\d+\\.png/);\n              if (imageFilenameMatch) {\n                const filename = imageFilenameMatch[0];\n                console.log(\n                  `Detected image filename pattern in database: ${filename}`\n                );\n\n                // Create direct URL to image uploads endpoint\n                const directUrl = `${window.location.origin}/api/image/uploads/${filename}`;\n                console.log(\n                  \"Created direct URL to image from database:\",\n                  directUrl\n                );\n\n                // Force update the image URL\n                this.localImage = directUrl;\n                this.$emit(\"update:image\", directUrl);\n\n                // Verify the image can be loaded\n                const img = new Image();\n                img.onload = () => {\n                  console.log(\n                    \"Image loaded successfully using direct URL:\",\n                    directUrl\n                  );\n                  this.imageError = null;\n                  this.imageLoading = false;\n                  this.showToast(\"Đã tải hình ảnh thành công\", \"success\");\n                };\n\n                img.onerror = (err) => {\n                  console.error(\"Failed to load image with direct URL:\", err);\n                  // Try one more time with a direct fetch to verify file exists\n                  fetch(directUrl, { method: \"HEAD\" })\n                    .then((response) => {\n                      if (response.ok) {\n                        console.log(\n                          \"Image exists on server but failed to load. Trying again...\"\n                        );\n                        // Force browser to reload the image by adding timestamp\n                        const timestamp = new Date().getTime();\n                        const urlWithCache = `${directUrl}?t=${timestamp}`;\n                        this.localImage = urlWithCache;\n                        this.$emit(\"update:image\", urlWithCache);\n                        this.imageLoading = false;\n                        this.showToast(\"Đã tải hình ảnh thành công\", \"success\");\n                      } else {\n                        throw new Error(`Server returned ${response.status}`);\n                      }\n                    })\n                    .catch((fetchErr) => {\n                      console.error(\"Image verification failed:\", fetchErr);\n                      this.imageError = \"Không thể tải hình ảnh từ server\";\n                      this.imageLoading = false;\n                      // Try debug as last resort\n                      this.debugImageUrl(content.imageUrl);\n                    });\n                };\n\n                img.src = directUrl;\n                return;\n              }\n\n              // Try standard URL processing if no filename pattern\n              const formattedUrl = this.ensureAbsoluteUrl(content.imageUrl);\n              console.log(\"Formatted URL for image:\", formattedUrl);\n\n              // Verify the image can be loaded\n              const standardImg = new Image();\n              standardImg.onload = () => {\n                console.log(\n                  \"Image loaded successfully with formatted URL:\",\n                  formattedUrl\n                );\n                this.localImage = formattedUrl;\n                this.$emit(\"update:image\", formattedUrl);\n                this.imageError = null;\n                this.imageLoading = false;\n                this.showToast(\"Đã tải hình ảnh thành công\", \"success\");\n              };\n\n              standardImg.onerror = () => {\n                console.error(\"Failed to load image with formatted URL\");\n                // Try fallback methods\n                this.tryAlternativeImageUrls(content.imageUrl);\n              };\n\n              standardImg.src = formattedUrl;\n            } else {\n              console.log(\"No image URL found in database\");\n\n              // Kiểm tra xem có generatedImage từ prop hoặc local state không\n              if (this.generatedImage || this.localImage) {\n                console.log(\"Using generatedImage or localImage instead\");\n\n                const imageToUse = this.localImage || this.generatedImage;\n\n                // Nếu là data URL, lưu vào database\n                if (\n                  typeof imageToUse === \"string\" &&\n                  imageToUse.startsWith(\"data:image\")\n                ) {\n                  console.log(\"Saving base64 image to database...\");\n                  this.saveBase64ImageToServer(imageToUse);\n                  return;\n                } else if (\n                  typeof imageToUse === \"object\" &&\n                  imageToUse.image &&\n                  imageToUse.image.startsWith(\"data:image\")\n                ) {\n                  console.log(\"Saving object image.image to database...\");\n                  this.saveBase64ImageToServer(imageToUse.image);\n                  return;\n                }\n              } else {\n                this.localImage = null;\n                this.imageError = \"Không tìm thấy hình ảnh trong cơ sở dữ liệu\";\n                this.imageLoading = false;\n              }\n            }\n          } else {\n            console.error(\"Error fetching content:\", response.data);\n            this.imageError = \"Lỗi khi tải dữ liệu nội dung\";\n            this.imageLoading = false;\n          }\n        })\n        .catch((error) => {\n          console.error(\"Error fetching content:\", error);\n          this.imageError = `Lỗi kết nối: ${error.message}`;\n          this.imageLoading = false;\n        });\n    },\n    // Thêm hàm mới để thử các phương pháp thay thế khi tải hình ảnh\n    tryAlternativeImageUrls(originalUrl) {\n      try {\n        console.log(\"Trying alternative methods to load image:\", originalUrl);\n\n        // First, look for image_XXXXXXXX.png pattern\n        const imageFilenameMatch = originalUrl.match(/image_\\d+\\.png/);\n        if (imageFilenameMatch) {\n          const filename = imageFilenameMatch[0];\n          console.log(`Found image filename pattern: ${filename}`);\n\n          // Create direct URL to image uploads endpoint\n          const directUrl = `${window.location.origin}/api/image/uploads/${filename}`;\n          console.log(\"Created direct URL to image:\", directUrl);\n\n          // Update URL immediately\n          this.localImage = directUrl;\n          this.$emit(\"update:image\", directUrl);\n          this.imageLoading = false;\n\n          // Still try loading to confirm\n          const img = new Image();\n          img.onload = () => {\n            console.log(\"Image loaded successfully from direct URL\");\n            this.imageError = null;\n          };\n          img.onerror = () => {\n            console.error(\"Image failed to load from direct URL\");\n            this.imageError = \"Không thể tải hình ảnh từ server\";\n            this.debugImageUrl(originalUrl);\n          };\n          img.src = directUrl;\n          return;\n        }\n\n        // Try to load the original URL image first\n        const img = new Image();\n        img.onload = () => {\n          console.log(\"Image loaded successfully from original URL\");\n          this.localImage = originalUrl;\n          this.$emit(\"update:image\", originalUrl);\n          this.imageLoading = false;\n        };\n\n        img.onerror = async () => {\n          console.log(\n            \"Failed to load image from original URL, trying alternate paths\"\n          );\n\n          // Try with /api prefix for server uploads\n          if (originalUrl.includes(\"uploads/\")) {\n            const uploadPathMatch = originalUrl.match(/(uploads\\/.*$)/);\n            if (uploadPathMatch && uploadPathMatch[1]) {\n              const apiUrl = `/api/image/${uploadPathMatch[1]}`;\n              console.log(\"Trying with API URL:\", apiUrl);\n\n              // Check if this URL works\n              const altImg = new Image();\n              altImg.onload = () => {\n                console.log(\"Image loaded successfully from API URL\");\n                this.localImage = apiUrl;\n                this.$emit(\"update:image\", apiUrl);\n                this.imageLoading = false;\n              };\n\n              altImg.onerror = () => {\n                console.log(\"Failed to load image from API URL\");\n\n                // Try one more time with absolute URL\n                const absoluteApiUrl = `${window.location.origin}${apiUrl}`;\n                console.log(\"Trying with absolute API URL:\", absoluteApiUrl);\n\n                const finalImg = new Image();\n                finalImg.onload = () => {\n                  console.log(\n                    \"Image loaded successfully from absolute API URL\"\n                  );\n                  this.localImage = absoluteApiUrl;\n                  this.$emit(\"update:image\", absoluteApiUrl);\n                  this.imageLoading = false;\n                };\n\n                finalImg.onerror = () => {\n                  console.log(\"All API URL attempts failed\");\n                  this.imageError = \"Không thể tải hình ảnh từ server\";\n                  this.localImage = null;\n                  this.imageLoading = false;\n\n                  // Final attempt - debug URL\n                  this.debugImageUrl(originalUrl);\n                };\n\n                finalImg.src = absoluteApiUrl;\n              };\n\n              altImg.src = apiUrl;\n            } else {\n              this.imageError = \"Invalid image path format\";\n              this.localImage = null;\n              this.imageLoading = false;\n\n              // Final attempt - debug URL\n              this.debugImageUrl(originalUrl);\n            }\n          } else {\n            this.imageError = \"Image not found\";\n            this.localImage = null;\n            this.imageLoading = false;\n\n            // Final attempt - debug URL\n            this.debugImageUrl(originalUrl);\n          }\n        };\n\n        // Ensure the URL is properly formatted\n        img.src = this.ensureAbsoluteUrl(originalUrl);\n      } catch (imgError) {\n        console.error(\"Error checking image:\", imgError);\n        this.localImage = originalUrl;\n        this.$emit(\"update:image\", originalUrl);\n        this.imageLoading = false;\n      }\n    },\n  },\n  watch: {\n    generatedImage: {\n      immediate: true,\n      handler(newValue, oldValue) {\n        if (newValue !== oldValue) {\n          console.log(\"generatedImage changed:\", newValue);\n\n          // If we get a new generatedImage value, update localImage\n          if (newValue) {\n            this.localImage = newValue;\n          }\n          // Don't clear localImage if newValue is null - we may already have a valid image\n          // from fetchContentImage\n        }\n      },\n    },\n    contentId: {\n      immediate: true,\n      handler(newValue, oldValue) {\n        if (newValue && newValue !== oldValue) {\n          console.log(\"Content ID changed from\", oldValue, \"to\", newValue);\n\n          // Only clear localImage if we're switching to a different content\n          if (oldValue) {\n            this.localImage = null;\n          }\n\n          // Always fetch the image when contentId changes\n          this.fetchContentImage();\n\n          // Tải dữ liệu hình ảnh từ cơ sở dữ liệu\n          this.loadImageFromDatabase();\n        }\n      },\n    },\n  },\n};\n</script>\n\n<style scoped>\n.step-content {\n  background: white;\n  border-radius: 12px;\n  padding: 2rem;\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n}\n\nh2 {\n  color: #1c1c4c;\n  margin-bottom: 1.5rem;\n  text-align: center;\n  font-weight: 600;\n}\n\n.project-info {\n  background: #f8f9fa;\n  border-radius: 8px;\n  padding: 1rem;\n  margin-bottom: 2rem;\n}\n\n.project-info h3 {\n  color: #1c1c4c;\n  margin: 0 0 0.5rem 0;\n}\n\n.project-info p {\n  color: #6c757d;\n  margin: 0 0 1rem 0;\n}\n\n.project-status {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  margin-top: 0.5rem;\n}\n\n.status-badge {\n  font-size: 0.75rem;\n  padding: 0.25rem 0.5rem;\n  border-radius: 12px;\n  font-weight: bold;\n}\n\n.status-badge.in_progress {\n  background-color: #ecedf7;\n  color: #1c1c4c;\n}\n\n.status-badge.finished {\n  background-color: #e8f5e9;\n  color: #28a745;\n}\n\n.status-button {\n  background: transparent;\n  border: 1px solid #1c1c4c;\n  color: #1c1c4c;\n  padding: 0.25rem 0.75rem;\n  border-radius: 4px;\n  cursor: pointer;\n  font-size: 0.8rem;\n  transition: all 0.3s ease;\n}\n\n.status-button:hover {\n  background: #ecedf7;\n}\n\n.final-content {\n  display: grid;\n  gap: 2rem;\n  margin-bottom: 2rem;\n}\n\n.final-content h3 {\n  margin-bottom: 1rem;\n  color: #1c1c4c;\n  font-weight: 600;\n}\n\n.content-box {\n  white-space: pre-wrap;\n  line-height: 1.6;\n  font-family: \"Arial\", sans-serif;\n  padding: 1.5rem;\n  background: white;\n  border-radius: 8px;\n  border: 1px solid #e9ecef;\n  max-height: 400px;\n  overflow-y: auto;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\n}\n\n.content-box p {\n  margin-bottom: 1rem;\n}\n\n.content-box h1,\n.content-box h2,\n.content-box h3,\n.content-box h4,\n.content-box h5,\n.content-box h6 {\n  margin-top: 1.5rem;\n  margin-bottom: 1rem;\n  color: #1c1c4c;\n}\n\n.final-image-section {\n  background: #f8f9fa;\n  border-radius: 8px;\n  padding: 2rem;\n  margin-bottom: 2rem;\n}\n\n.final-image-section h3 {\n  margin-bottom: 1.5rem;\n  color: #1c1c4c;\n  font-weight: 600;\n}\n\n.image-section {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n}\n\n.image-loading {\n  width: 100%;\n  height: 200px;\n  display: flex;\n  flex-direction: column;\n  gap: 1rem;\n}\n\n.loading-text {\n  color: #6c757d;\n  font-size: 0.9rem;\n  text-align: center;\n}\n\n.image-section img {\n  max-width: 100%;\n  max-height: 300px;\n  object-fit: contain;\n  border-radius: 8px;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n}\n\n.no-image-placeholder {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  min-height: 200px;\n  color: #6c757d;\n  background-color: #f8f9fa;\n  border-radius: 6px;\n  margin-bottom: 1rem;\n}\n\n.no-image-placeholder p {\n  margin-top: 0.5rem;\n  font-size: 0.9rem;\n}\n\n.image-actions {\n  margin-top: 1rem;\n  width: 100%;\n  display: flex;\n  justify-content: center;\n}\n\n.final-actions {\n  margin-top: 2rem;\n  margin-bottom: 2rem;\n}\n\n.additional-actions {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 1rem;\n  margin-bottom: 1.5rem;\n  justify-content: center;\n}\n\n.navigation-buttons {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 1rem;\n  justify-content: center;\n}\n\n.action-buttons {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 1rem;\n  margin-bottom: 1.5rem;\n  justify-content: center;\n}\n\n.btn {\n  min-width: 120px;\n  text-align: center;\n  padding: 0.75rem 1.25rem;\n  border-radius: 6px;\n  font-size: 0.9rem;\n  transition: all 0.3s ease;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 0.5rem;\n}\n\n.btn-primary {\n  background: #1c1c4c;\n  color: white;\n  border: none;\n}\n\n.btn-primary:hover {\n  background: #2a2a6c;\n}\n\n.btn-outline-primary {\n  background: transparent;\n  border: 1px solid #1c1c4c;\n  color: #1c1c4c;\n}\n\n.btn-outline-primary:hover {\n  background: #ecedf7;\n}\n\n.btn-light {\n  background: white;\n  color: #1c1c4c;\n  border: 1px solid #1c1c4c;\n}\n\n.btn-light:hover {\n  background: #f8f9fa;\n}\n\n.btn-info {\n  background: white;\n  color: #1c1c4c;\n  border: 1px solid #1c1c4c;\n}\n\n.btn-info:hover {\n  background: #f8f9fa;\n}\n\n.btn-success {\n  background: #1c1c4c;\n  color: white;\n  border: none;\n}\n\n.btn-success:hover {\n  background: #2a2a6c;\n}\n\n.error-message {\n  color: #dc3545;\n  font-size: 0.9rem;\n  margin-top: 0.5rem;\n}\n\n.project-info.warning {\n  background-color: #fff3cd;\n  border: 1px solid #ffeeba;\n  color: #856404;\n}\n\n.status-button:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n}\n\n.save-message {\n  margin-top: 1rem;\n  padding: 0.75rem;\n  border-radius: 4px;\n  text-align: center;\n  font-size: 0.9rem;\n}\n\n.save-message.success {\n  background-color: #e8f5e9;\n  color: #28a745;\n}\n\n.save-message.error {\n  background-color: #ffebee;\n  color: #dc3545;\n}\n\n@media (max-width: 768px) {\n  .action-buttons,\n  .navigation-buttons,\n  .additional-actions {\n    flex-direction: column;\n    width: 100%;\n  }\n\n  .action-buttons button,\n  .navigation-buttons button,\n  .additional-actions button {\n    width: 100%;\n    margin-bottom: 0.5rem;\n  }\n\n  .btn {\n    width: 100%;\n  }\n}\n\n/* Toast Styles */\n.toast-container {\n  position: fixed;\n  top: 20px;\n  right: 20px;\n  z-index: 1000;\n  display: flex;\n  flex-direction: column;\n  gap: 10px;\n  max-width: 350px;\n}\n\n.toast-message {\n  padding: 12px 16px;\n  border-radius: 6px;\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  animation: slide-in 0.3s ease-out forwards;\n  cursor: pointer;\n  color: white;\n}\n\n.toast-success {\n  background-color: #42b983;\n}\n\n.toast-error {\n  background-color: #e74c3c;\n}\n\n.toast-info {\n  background-color: #3498db;\n}\n\n.toast-close-btn {\n  background: none;\n  border: none;\n  color: white;\n  font-size: 20px;\n  cursor: pointer;\n  margin-left: 8px;\n  opacity: 0.7;\n}\n\n.toast-close-btn:hover {\n  opacity: 1;\n}\n\n@keyframes slide-in {\n  from {\n    transform: translateX(100%);\n    opacity: 0;\n  }\n  to {\n    transform: translateX(0);\n    opacity: 1;\n  }\n}\n\n.image-error-actions {\n  display: flex;\n  justify-content: center;\n  gap: 0.5rem;\n  margin-top: 0.5rem;\n}\n</style>\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}